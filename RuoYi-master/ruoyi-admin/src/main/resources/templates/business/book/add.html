<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">
<head>
    <th:block th:include="include :: header('新增图书管理')"/>
    <style>
        /* 图片预览容器样式优化 */
        .img-preview {
            margin-top: 10px;
            max-width: 300px;
            max-height: 200px;
            border: 1px solid #e6e6e6;
            border-radius: 4px;
            display: none;
        }
        /* 修复双列布局换行问题 */
        .form-horizontal.m {
            overflow: hidden;
            padding: 15px;
        }
        .col-md-6 {
            margin-bottom: 15px;
        }
    </style>
</head>
<body class="white-bg">
<div class="wrapper wrapper-content animated fadeInRight ibox-content">
    <form class="form-horizontal m" id="form-book-add">
        <!-- 原有HTML结构不变 -->
        <!-- 双列布局：左列 col-md-6 -->
        <div class="col-md-6">
            <div class="form-group">
                <label class="col-sm-3 control-label">图书编号：</label>
                <div class="col-sm-9">
                    <input name="bookNo" class="form-control" type="text" placeholder="请输入图书编号" maxlength="50">
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-3 control-label is-required">图书名称：</label>
                <div class="col-sm-9">
                    <input name="bookName" class="form-control" type="text" required placeholder="请输入图书名称">
                </div>
            </div>
            <!-- 完善图片上传回显模块 -->
            <div class="form-group">
                <label class="col-sm-3 control-label">图片：</label>
                <div class="col-sm-9">
                    <!-- 文件选择框（隐藏默认样式） -->
                    <input type="file" id="imgFile" accept="image/*" style="display: none;" onchange="previewImage(this)">
                    <!-- 操作按钮 -->
                    <button type="button" class="btn btn-primary btn-sm" onclick="$('#imgFile').click()">选择图片</button>
                    <button type="button" class="btn btn-success btn-sm ml-1" onclick="uploadImage()">上传图片</button>
                    <!-- 隐藏域：存储图片服务器地址 -->
                    <input type="hidden" id="imgUrl" name="imgUrl">
                    <!-- 图片预览容器 -->
                    <img class="img-container img-lg img-preview" id="previewImg" />
                    <div class="text-muted mt-1" style="font-size: 12px;">
                        提示：仅支持jpg/png/gif格式，大小不超过2MB
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-3 control-label">作者：</label>
                <div class="col-sm-9">
                    <input name="author" class="form-control" type="text" placeholder="请输入作者名称" maxlength="50">
                </div>
            </div>
        </div>

        <!-- 双列布局：右列 col-md-6 -->
        <div class="col-md-6">
            <div class="form-group">
                <label class="col-sm-3 control-label is-required">出版社：</label>
                <div class="col-sm-9">
                    <input name="press" class="form-control" type="text" required placeholder="请输入出版社名称">
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-3 control-label">库存：</label>
                <div class="col-sm-9">
                    <input name="stock" class="form-control" type="number" min="0" placeholder="请输入非负整数" value="0">
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-3 control-label">出版时间：</label>
                <div class="col-sm-9">
                    <div class="input-group date">
                        <span class="input-group-addon"><i class="fa fa-calendar"></i></span>
                        <input type="text"
                               id="publicTime"
                               name="publicTime"
                               class="form-control"
                               placeholder="请选择出版时间"
                               readonly>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-3 control-label">图书状态：</label>
                <div class="col-sm-9">
                    <label class="radio-inline">
                        <input type="radio" name="status" value="0" checked> 上架
                    </label>
                    <label class="radio-inline">
                        <input type="radio" name="status" value="1"> 下架
                    </label>
                </div>
            </div>
        </div>

        <!-- 表单提交按钮 -->
        <div class="col-xs-12 text-center" style="margin-top: 20px; clear: both;">
            <button type="button" class="btn btn-primary" onclick="submitHandler()">提交</button>
            <button type="reset" class="btn btn-default ml-2" onclick="resetPreview()">重置</button>
        </div>
    </form>
</div>

<th:block th:include="include :: footer"/>
<script th:inline="javascript">
    var prefix = ctx + "business/book";
    // 新增：存储本地预览的base64地址（避免上传后替换成filename导致预览失效）
    var localPreviewSrc = "";

    // 初始化日期选择器
    $(function() {
        laydate.render({
            elem: '#publicTime',
            type: 'date',
            format: 'yyyy-MM-dd',
            clear: true,
            trigger: 'click',
            value: new Date().toLocaleDateString().replace(/\//g, '-')
        });

        $("#form-book-add").on("reset", function() {
            resetPreview();
        });
    });

    // 表单校验规则
    $("#form-book-add").validate({
        focusCleanup: true,
        ignore: "",
        rules: {
            bookNo: { maxlength: 50, remote: { url: prefix + "/checkBookNoUnique", type: "post", data: { bookNo: function() { return $("input[name='bookNo']").val().trim(); } } } },
            bookName: { required: true, maxlength: 100 },
            author: { maxlength: 50 },
            press: { required: true, maxlength: 100 },
            publicTime: { pattern: /^\d{4}-\d{2}-\d{2}$/ },
            stock: { number: true, min: 0, digits: true },
            imgUrl: { maxlength: 255 },
            status: { required: true }
        },
        messages: {
            bookNo: { maxlength: "图书编号长度不能超过50个字符", remote: "图书编号已存在，请更换" },
            bookName: { required: "图书名称不能为空", maxlength: "图书名称长度不能超过100个字符" },
            author: { maxlength: "作者名称长度不能超过50个字符" },
            press: { required: "出版社不能为空", maxlength: "出版社名称长度不能超过100个字符" },
            publicTime: { pattern: "出版时间格式错误，请选择 YYYY-MM-DD 格式的日期" },
            stock: { number: "库存必须为数字", min: "库存不能为负数", digits: "库存必须为整数" },
            status: { required: "请选择图书状态" }
        },
        errorPlacement: function(error, element) {
            if (element.attr("type") === "radio") {
                error.appendTo(element.parents(".col-sm-9"));
            } else {
                error.insertAfter(element);
            }
        }
    });

    // 图片预览函数：仅存储本地base64，不上传
    function previewImage(fileInput) {
        if (!fileInput.files || !fileInput.files[0]) {
            $.modal.msgWarning("请选择要上传的图片！");
            return;
        }
        const file = fileInput.files[0];
        // 校验文件类型和大小
        if (!file.type.startsWith('image/')) {
            $.modal.msgError("请选择图片格式的文件（jpg/png/gif等）！");
            fileInput.value = "";
            return;
        }
        if (file.size > 2 * 1024 * 1024) {
            $.modal.msgError("图片大小不能超过2MB！");
            fileInput.value = "";
            return;
        }
        // 读取本地文件，存储base64地址用于预览
        const reader = new FileReader();
        reader.onload = function(e) {
            localPreviewSrc = e.target.result; // 保存本地预览地址
            $("#previewImg").attr("src", localPreviewSrc).show(); // 显示本地预览图
        };
        reader.readAsDataURL(file);
    }

    // 上传图片函数：仅验证+存储filename，不替换预览图
    function uploadImage() {
        const fileInput = $("#imgFile")[0];
        if (!fileInput.files || !fileInput.files[0]) {
            $.modal.msgWarning("请先选择要上传的图片！");
            return;
        }
        if (!localPreviewSrc) {
            $.modal.msgWarning("请先完成图片本地预览！");
            return;
        }

        const formData = new FormData();
        formData.append("file", fileInput.files[0]);
        const loadIndex = layer.load(1, {shade: [0.1, '#fff']});

        $.ajax({
            url: "http://localhost:8000/predict",
            type: "POST",
            data: formData,
            contentType: false,
            processData: false,
            dataType: "json",
            success: function(res) {
                layer.close(loadIndex);
                if (!res.data) {
                    $.modal.msgError("接口返回异常：未获取到图片识别数据");
                    return;
                }

                if (res.code === 200) {
                    // 重置隐藏域（避免残留）
                    $("#imgUrl").val("");

                    if (res.data.is_book) {
                        // 验证通过：仅存储filename到隐藏域，预览图保留本地base64（避免路径问题）
                        $("#imgUrl").val(res.data.filename);
                        $.modal.msgInfo(`
                            识别结果：是图书图片<br/>
                            置信度：${res.data.confidence}<br/>
                            阈值：${res.data.threshold}<br/>
                            模型信息：${res.data.model_info}
                        `);
                        $.modal.msgSuccess("图片验证成功！文件名已保存");
                        // 关键：不修改预览图的src，保持本地base64显示
                    } else {
                        // 验证失败：隐藏预览图+清空数据
                        $("#previewImg").hide().attr("src", "");
                        localPreviewSrc = "";
                        $.modal.msgError(`上传失败：该图片不是图书相关图片（置信度：${res.data.confidence}），请重新选择！`);
                    }
                } else {
                    $.modal.msgError("图片上传失败：" + (res.msg || "接口返回异常"));
                }
            },
            error: function(xhr, status, error) {
                layer.close(loadIndex);
                $.modal.msgError(`图片上传请求失败：${status} - ${error}`);
                console.error("上传错误详情：", xhr);
            },
            complete: function() {
                $("#imgFile").val(""); // 清空文件选择框，不影响预览图
            }
        });
    }

    // 重置图片预览
    function resetPreview() {
        $("#previewImg").hide().attr("src", "");
        $("#imgUrl").val("");
        $("#imgFile").val("");
        localPreviewSrc = ""; // 清空本地预览地址
    }

    // 提交处理函数
    function submitHandler() {
        if ($("#form-book-add").valid()) {
            if (!$("#imgUrl").val()) {
                $.modal.msgWarning("请先上传并验证通过的图书图片！");
                return;
            }

            var publicTimeVal = $("#publicTime").val().trim();
            if (publicTimeVal === "") {
                $("#publicTime").val("");
            }

            layer.confirm('确认提交当前图书信息？', {
                btn: ['确认','取消'],
                shade: 0.3
            }, function() {
                $.operate.save(prefix + "/add", $('#form-book-add').serialize(), function() {
                    var index = parent.layer.getFrameIndex(window.name);
                    parent.layer.close(index);
                    parent.$('.btn-refresh').click();
                });
            });
        }
    }
</script>
</body>
</html>