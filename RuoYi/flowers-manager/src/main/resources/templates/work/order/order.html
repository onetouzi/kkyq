<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org" xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">
<head>
    <th:block th:include="include :: header('花卉订单列表')" />
</head>
<body class="gray-bg">
     <div class="container-div">
        <div class="row">
            <div class="col-sm-12 search-collapse">
                <form id="formId">
                    <div class="select-list">
                        <ul>
                            <li>
                                <label>订单号：</label>
                                <input type="text" name="orderId"/>
                            </li>
                            <li>
                                <label>用户ID：</label>
                                <input type="text" name="userId"/>
                            </li>
                            <li>
                                <label>买家姓名：</label>
                                <input type="text" name="userName"/>
                            </li>
                            <li>
                                <label>花卉ID：</label>
                                <input type="text" name="flowerId"/>
                            </li>
                            <li>
                                <label>花卉名称：</label>
                                <input type="text" name="flowerName"/>
                            </li>
                            <li>
                                <label>购买数量：</label>
                                <input type="text" name="quantity"/>
                            </li>
                            <li>
                                <label>总金额：</label>
                                <input type="text" name="totalPrice"/>
                            </li>
                            <li>
                                <label>创建时间：</label>
                                <input type="text" name="createTime"/>
                            </li>
                            <li>
                                <a class="btn btn-primary btn-rounded btn-sm" onclick="$.table.search()"><i class="fa fa-search"></i>&nbsp;搜索</a>
                                <a class="btn btn-warning btn-rounded btn-sm" onclick="$.form.reset()"><i class="fa fa-refresh"></i>&nbsp;重置</a>
                            </li>
                        </ul>
                    </div>
                </form>
            </div>

            <div class="btn-group-sm" id="toolbar" role="group">
                <a class="btn btn-success" onclick="$.operate.add()" shiro:hasPermission="work:order:add">
                    <i class="fa fa-plus"></i> 添加
                </a>
                <a class="btn btn-danger multiple disabled" onclick="batchRemove()" shiro:hasPermission="work:order:remove">
                    <i class="fa fa-remove"></i> 批量删除
                </a>
                <a class="btn btn-warning" onclick="$.table.exportExcel()" shiro:hasPermission="work:order:export">
                    <i class="fa fa-download"></i> 导出
                </a>
            </div>
            <div class="col-sm-12 select-table table-striped">
                <table id="bootstrap-table"></table>
            </div>
        </div>
    </div>
    <th:block th:include="include :: footer" />
    <script th:inline="javascript">
        var editFlag = [[${@permission.hasPermi('work:order:edit')}]];
        var removeFlag = [[${@permission.hasPermi('work:order:remove')}]];
        var prefix = ctx + "work/order";

        // 精确删除单条记录
        function removeOne(orderId, userId, flowerId) {
            $.modal.confirm("确认要删除该订单中的这件花卉吗？", function() {
                var url = prefix + "/remove";
                var data = {
                    "orderId": orderId,
                    "userId": userId,
                    "flowerId": flowerId
                };
                // 使用若依内置的异步提交方法
                $.operate.submit(url, "post", "json", data);
            });
        }

        function batchRemove() {
            // 1. 获取选中的行数据
            var rows = $.table.selectColumns("orderId"); // 这里只是为了判断有没有选中
            if (rows.length == 0) {
                $.modal.alertWarning("请至少选择一条记录");
                return;
            }

            $.modal.confirm("确认要删除选中的 " + rows.length + " 条订单吗？", function() {
                var url = prefix + "/removeBatch"; // 建议起个新名字区分

                // 2. 提取所有选中行的复合主键
                var selectedRows = $("#bootstrap-table").bootstrapTable('getSelections');
                var dataList = [];

                $.each(selectedRows, function(index, row) {
                    dataList.push({
                        "orderId": row.orderId,
                        "userId": row.userId,
                        "flowerId": row.flowerId
                    });
                });

                // 3. 提交到后端 (发送 JSON 数据)
                var config = {
                    url: url,
                    type: "post",
                    dataType: "json",
                    contentType: "application/json;charset=utf-8", // 必须指定 JSON
                    data: JSON.stringify(dataList),
                    beforeSend: function () {
                        $.modal.loading("正在处理中，请稍候...");
                    },
                    success: function(result) {
                        $.operate.ajaxSuccess(result);
                    }
                };
                $.ajax(config);
            });
        }

        function cancelOrder(orderId, userId, flowerId) {
            $.modal.confirm("确认要取消该订单吗？取消后库存将自动返还。", function() {
                var url = prefix + "/cancel"; // 对应后台新写的接口
                var data = {
                    "orderId": orderId,
                    "userId": userId,
                    "flowerId": flowerId
                };
                $.operate.submit(url, "post", "json", data);
            });
        }

        $(function() {
            var options = {
                url: prefix + "/list",
                createUrl: prefix + "/add",
                updateUrl: prefix + "/edit/{id}",
                removeUrl: prefix + "/remove",
                exportUrl: prefix + "/export",
                modalName: "花卉订单",
                columns: [{
                    checkbox: true,
                    formatter: function (value, row, index) {
                        // 将复合主键拼接成一个字符串存入 checkbox 的 value
                        return {
                            value: row.orderId + "_" + row.userId + "_" + row.flowerId
                        };
                    }
                },
                {
                    field: 'orderId',
                    title: '订单ID',
                    visible: true
                },
                {
                    field: 'userId',
                    title: '用户ID'
                },
                {
                    field: 'userName',
                    title: '买家姓名'
                },
                {
                    field: 'flowerId',
                    title: '花卉ID'
                },
                {
                    field: 'flowerName',
                    title: '花卉名称'
                },
                {
                    field: 'quantity',
                    title: '购买数量'
                },
                {
                    field: 'totalPrice',
                    title: '总金额'
                },
                {
                    field: 'status',
                    title: '状态',
                    formatter: function(value, row, index) {
                        if (value == '0') {
                            return '<span class="badge badge-primary">已支付</span>';
                        } else if (value == '1') {
                            return '<span class="badge badge-danger">未支付</span>';
                        } else {
                            return '<span class="badge badge-secondary">已取消</span>';
                        }
                        return value;
                    }
                },
                {
                    field: 'remark',
                    title: '备注'
                },
                    {
                        field: 'createTime',
                        title: '创建时间'
                    },
                    {
                        title: '操作',
                        align: 'center',
                        formatter: function(value, row, index) {
                            var actions = [];
                            // 构造编辑 URL
                            var editUrl = prefix + '/edit/' + row.orderId +
                                '?userId=' + encodeURIComponent(row.userId) +
                                '&flowerId=' + encodeURIComponent(row.flowerId);

                            // --- 编辑按钮逻辑优化 ---
                            if (row.status == '0') {
                                // 已支付：禁用
                                actions.push('<a class="btn btn-default btn-xs disabled" title="已支付订单不可修改"><i class="fa fa-edit"></i>编辑</a> ');
                            } else if (row.status == '1') {
                                // 未支付：允许编辑
                                actions.push('<a class="btn btn-success btn-xs ' + editFlag + '" href="javascript:void(0)" onclick="$.modal.open(\'修改订单\', \'' + editUrl + '\')"><i class="fa fa-edit"></i>编辑</a> ');
                            } else {
                                // 已取消（或其他状态）：禁用
                                actions.push('<a class="btn btn-default btn-xs disabled" title="已取消订单不可修改"><i class="fa fa-edit"></i>编辑</a> ');
                            }

                            // --- 取消按钮逻辑 (仅未支付 '1' 显示) ---
                            if (row.status == '1') {
                                actions.push('<a class="btn btn-warning btn-xs ' + editFlag + '" href="javascript:void(0)" onclick="cancelOrder(\'' + row.orderId + '\',\'' + row.userId + '\',\'' + row.flowerId + '\')"><i class="fa fa-close"></i>取消</a> ');
                            }

                            // --- 删除按钮逻辑 ---
                            actions.push('<a class="btn btn-danger btn-xs ' + removeFlag + '" href="javascript:void(0)" onclick="removeOne(\'' + row.orderId + '\',\'' + row.userId + '\',\'' + row.flowerId + '\')"><i class="fa fa-remove"></i>删除</a>');

                            return actions.join('');
                        }
                    }]
            };
            $.table.init(options);
        });
    </script>
</body>
</html>