<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org" >
<head>
    <th:block th:include="include :: header('修改花卉信息')" />
    <style>
        .img-preview { width: 150px; height: 150px; margin-top: 10px; border: 1px solid #ddd; display: block; border-radius: 4px; object-fit: cover;}
        .ml-1 { margin-left: 5px; }
        .profit-tip { font-size: 12px; margin-top: 5px; display: block; }
        .text-profit { color: #1ab394; font-weight: bold; }
        .text-loss { color: #ed5565; font-weight: bold; }

        /* AI 识别结果样式 */
        .predict-container {
            margin-top: 10px;
            padding: 8px;
            border-radius: 4px;
            background-color: #f9f9f9;
            border: 1px solid #e7eaec;
            display: none; /* 初始隐藏，上传后显示 */
            width: fit-content;
            min-width: 200px;
        }
        .badge-ai { font-size: 11px; padding: 3px 8px; }
    </style>
</head>
<body class="white-bg">
<div class="wrapper wrapper-content animated fadeInRight ibox-content">
    <form class="form-horizontal m" id="form-flower-edit" th:object="${flower}">
        <input name="flowerId" th:field="*{flowerId}" type="hidden">

        <div class="col-xs-12">
            <div class="form-group">
                <label class="col-sm-3 control-label is-required">花卉名称：</label>
                <div class="col-sm-8">
                    <input name="flowerName" th:field="*{flowerName}" class="form-control" type="text" required>
                </div>
            </div>
        </div>

        <div class="col-xs-12">
            <div class="form-group">
                <label class="col-sm-3 control-label">花卉编码：</label>
                <div class="col-sm-8">
                    <input name="flowerCode" th:field="*{flowerCode}" class="form-control" type="text" readonly placeholder="系统自动生成">
                </div>
            </div>
        </div>

        <div class="col-xs-12">
            <div class="form-group">
                <label class="col-sm-3 control-label">花卉类型：</label>
                <div class="col-sm-8">
                    <select name="flowerType" th:field="*{flowerType}" class="form-control m-b">
                        <option value="观花类">观花类</option>
                        <option value="观叶类">观叶类</option>
                        <option value="观果类">观果类</option>
                        <option value="多肉类">多肉类</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="col-xs-12">
            <div class="form-group">
                <label class="col-sm-3 control-label is-required">进价：</label>
                <div class="col-sm-8">
                    <input name="purchasePrice" id="purchasePrice" th:field="*{purchasePrice}" class="form-control" type="number" step="0.01" required>
                </div>
            </div>
        </div>

        <div class="col-xs-12">
            <div class="form-group">
                <label class="col-sm-3 control-label is-required">售价：</label>
                <div class="col-sm-8">
                    <input name="price" id="price" th:field="*{price}" class="form-control" type="number" step="0.01" required>
                    <span id="margin-info" class="profit-tip text-muted">输入价格计算毛利率</span>
                </div>
            </div>
        </div>

        <div class="col-xs-12">
            <div class="form-group">
                <label class="col-sm-3 control-label is-required">库存量：</label>
                <div class="col-sm-8">
                    <input name="num" th:field="*{num}" class="form-control" type="number" required>
                </div>
            </div>
        </div>

        <div class="col-xs-12">
            <div class="form-group">
                <label class="col-sm-3 control-label is-required">单位：</label>
                <div class="col-sm-8">
                    <input name="unit" th:field="*{unit}" class="form-control" type="text" required>
                </div>
            </div>
        </div>

        <div class="col-xs-12">
            <div class="form-group">
                <label class="col-sm-3 control-label">花卉图片：</label>
                <div class="col-sm-8">
                    <input type="file" id="imgFile" accept="image/*" style="display: none;" onchange="previewImage(this)">
                    <button type="button" class="btn btn-primary btn-sm" onclick="$('#imgFile').click()">选择图片</button>
                    <button type="button" class="btn btn-success btn-sm ml-1" onclick="uploadImage()">上传并AI识别</button>
                    <input type="hidden" id="image" name="image" th:field="*{image}">

                    <img class="img-preview" id="previewImg" th:src="*{image} ? *{image} : @{/img/profile.jpg}" />

                    <div id="predict-container" class="predict-container">
                        <div>
                            <span id="predict-badge" class="badge badge-ai"></span>
                            <span id="predict-score" class="ml-1" style="font-weight: bold;"></span>
                        </div>
                        <div id="predict-info" class="text-muted" style="font-size: 11px; margin-top: 5px;"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xs-12">
            <div class="form-group">
                <label class="col-sm-3 control-label">备注：</label>
                <div class="col-sm-8">
                    <textarea name="remark" class="form-control">[[*{remark}]]</textarea>
                </div>
            </div>
        </div>
    </form>
</div>
<th:block th:include="include :: footer" />
<script th:inline="javascript">
    var prefix = ctx + "work/flower";

    $("#form-flower-edit").validate({
        rules: {
            purchasePrice: { number: true, min: 0 },
            price: { number: true, min: 0 },
            num: { digits: true }
        },
        focusCleanup: true
    });

    function submitHandler() {
        if ($.validate.form()) {
            $.operate.save(prefix + "/edit", $('#form-flower-edit').serialize());
        }
    }

    // ========== 实时毛利率计算逻辑 ==========
    function calcMargin() {
        var buy = parseFloat($("#purchasePrice").val());
        var sell = parseFloat($("#price").val());
        if (!isNaN(buy) && !isNaN(sell) && sell !== 0) {
            var margin = ((sell - buy) / sell * 100).toFixed(2);
            var text = "预计毛利率：" + margin + "%";
            $("#margin-info").text(text).removeClass("text-profit text-loss");
            margin >= 0 ? $("#margin-info").addClass("text-profit") : $("#margin-info").addClass("text-loss");
        } else {
            $("#margin-info").text("输入价格计算毛利率").removeClass("text-profit text-loss");
        }
    }

    $(function() {
        // 初始化计算
        calcMargin();
        // 绑定输入事件
        $("#purchasePrice, #price").on("input", calcMargin);
    });

    // ========== 图片预览与上传逻辑 ==========
    function previewImage(fileInput) {
        if (!fileInput.files || fileInput.files.length === 0) return;
        const file = fileInput.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
            $("#previewImg").attr("src", e.target.result);
            // 重新选择图片时隐藏之前的AI结果
            $("#predict-container").hide();
        };
        reader.readAsDataURL(file);
    }

    function uploadImage() {
        const fileInput = $("#imgFile")[0];
        if (!fileInput.files || fileInput.files.length === 0) {
            $.modal.msgWarning("请选择图片");
            return;
        }

        const formData = new FormData();
        formData.append("file", fileInput.files[0]);

        // 开启加载层
        var index = layer.load(2, {shade: [0.1, '#fff']});

        $.ajax({
            url: prefix + "/upload",
            type: "POST",
            data: formData,
            contentType: false,
            processData: false,
            success: function(res) {
                layer.close(index);
                if (res.code === 0 || res.code === 200) {
                    // 更新隐藏域和预览图
                    $("#image").val(res.fileName);
                    $("#previewImg").attr("src", res.url);

                    // 处理 AI 识别结果 (根据您提供的JSON结构)
                    const pr = res.predictResult;
                    if (pr && pr.code === 200) {
                        const $container = $("#predict-container");
                        const $badge = $("#predict-badge");
                        const $score = $("#predict-score");
                        const $info = $("#predict-info");

                        $container.fadeIn();
                        const isTarget = pr.data.is_target;
                        const scorePercent = (pr.data.score * 100).toFixed(2) + "%";

                        if (isTarget) {
                            $badge.removeClass("badge-danger").addClass("badge-primary").text("AI 校验通过");
                            $score.removeClass("text-danger").addClass("text-navy").text("置信度: " + scorePercent);
                            $info.text("识别引擎: " + pr.data.model_info);
                            $.modal.msgSuccess("上传成功并通过 AI 校验");
                        } else {
                            $badge.removeClass("badge-primary").addClass("badge-danger").text("AI 提醒：内容不符");
                            $score.removeClass("text-navy").addClass("text-danger").text("匹配度: " + scorePercent);
                            $info.text("警告：该图片疑似不符合花卉分类要求");
                            $.modal.alertWarning("AI 提示：检测到该图片可能非目标花卉内容，请检查图片！");
                        }
                    } else {
                        $.modal.msgSuccess("上传成功");
                    }
                } else {
                    $.modal.msgError(res.msg || "上传失败");
                }
            },
            error: function() {
                layer.close(index);
                $.modal.msgError("上传请求失败");
            }
        });
    }
</script>
</body>
</html>