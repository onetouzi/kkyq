<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org" >
<head>
    <th:block th:include="include :: header('修改图书')" />
    <th:block th:include="include :: datetimepicker-css" />
</head>
<body class="white-bg">
    <div class="wrapper wrapper-content animated fadeInRight ibox-content">
        <form class="form-horizontal m" id="form-book-edit" th:object="${book}">
            <input name="id" th:field="*{id}" type="hidden">
            <div class="col-xs-12">
                <div class="form-group">
                    <label class="col-sm-3 control-label">图书编号：</label>
                    <div class="col-sm-8">
                        <input name="bookNo" th:field="*{bookNo}" class="form-control" type="text" required>
                    </div>
                </div>
            </div>
            <div class="col-xs-12">
                <div class="form-group">
                    <label class="col-sm-3 control-label is-required">图书名称：</label>
                    <div class="col-sm-8">
                        <input name="bookName" th:field="*{bookName}" class="form-control" type="text" required>
                    </div>
                </div>
            </div>
            <div class="col-xs-12">
                <div class="form-group">
                    <label class="col-sm-3 control-label">图片：</label>
                    <div class="col-sm-9">
                        <input type="file" id="imgFile" accept="image/*" style="display: none;" onchange="previewImage(this)">
                        <button type="button" class="btn btn-primary btn-sm" onclick="$('#imgFile').click()">选择图片</button>
                        <button type="button" class="btn btn-success btn-sm ml-1" onclick="uploadImage()">上传图片</button>
                        <!-- 隐藏域存储返回的firstName -->
                        <input type="hidden" id="img" name="img">
                        <img class="img-container img-lg img-preview" id="previewImg" />
                        <div class="text-muted mt-1" style="font-size: 12px;">
                            提示：仅支持jpg/png/gif格式，大小不超过2MB
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xs-12">
                <div class="form-group">
                    <label class="col-sm-3 control-label">作者：</label>
                    <div class="col-sm-8">
                        <input name="author" th:field="*{author}" class="form-control" type="text">
                    </div>
                </div>
            </div>
            <div class="col-xs-12">
                <div class="form-group">
                    <label class="col-sm-3 control-label">出版社：</label>
                    <div class="col-sm-8">
                        <input name="press" th:field="*{press}" class="form-control" type="text">
                    </div>
                </div>
            </div>
            <div class="col-xs-12">
                <div class="form-group">
                    <label class="col-sm-3 control-label">出版时间：</label>
                    <div class="col-sm-8">
                        <div class="input-group date">
                            <input name="publicTime" th:value="${#dates.format(book.publicTime, 'yyyy-MM-dd')}" class="form-control" placeholder="yyyy-MM-dd" type="text">
                            <span class="input-group-addon"><i class="fa fa-calendar"></i></span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xs-12">
                <div class="form-group">
                    <label class="col-sm-3 control-label">库存：</label>
                    <div class="col-sm-8">
                        <input name="stock" th:field="*{stock}" class="form-control" type="text">
                    </div>
                </div>
            </div>
            <div class="col-xs-12">
                <div class="form-group">
                    <label class="col-sm-3 control-label">图书类别，用逗号分割(科幻,日常)：</label>
                    <div class="col-sm-8">
                        <input name="typeName" th:field="*{typeName}" class="form-control" type="text">
                    </div>
                </div>
            </div>
        </form>
    </div>
    <th:block th:include="include :: footer" />
    <th:block th:include="include :: datetimepicker-js" />
    <script th:inline="javascript">
        var prefix = ctx + "work/book";
        $("#form-book-edit").validate({
            focusCleanup: true
        });

        function submitHandler() {
            if ($.validate.form()) {
                $.operate.save(prefix + "/edit", $('#form-book-edit').serialize());
            }
        }

        $("input[name='publicTime']").datetimepicker({
            format: "yyyy-mm-dd",
            minView: "month",
            autoclose: true
        });

        // ========== 图片预览 ==========
        function previewImage(fileInput) {
            try {
                if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
                    $.modal.msgWarning("请选择要上传的图片！");
                    return;
                }
                const file = fileInput.files[0];
                const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/jpg'];
                if (!validTypes.includes(file.type)) {
                    $.modal.msgError("请选择jpg/png/gif格式的图片文件！");
                    fileInput.value = "";
                    return;
                }
                if (file.size > 2 * 1024 * 1024) {
                    $.modal.msgError("图片大小不能超过2MB，请更换！");
                    fileInput.value = "";
                    return;
                }
                const reader = new FileReader();
                reader.onload = function(e) {
                    localPreviewSrc = e.target.result;
                    $("#previewImg").attr("src", localPreviewSrc).show();
                    $.modal.msgSuccess("图片预览成功！");
                };
                reader.onerror = function() {
                    $.modal.msgError("图片预览失败，请重新选择！");
                    fileInput.value = "";
                };
                reader.readAsDataURL(file);
            } catch (e) {
                console.error("预览图片异常：", e);
                $.modal.msgError("预览图片出错：" + e.message);
            }
        }

        // ========== 图片上传 ==========
        function uploadImage() {
            try {
                const fileInput = $("#imgFile")[0];
                if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
                    $.modal.msgWarning("请先选择要上传的图片！");
                    return;
                }
                if (!localPreviewSrc) {
                    $.modal.msgWarning("请先完成图片预览后再上传！");
                    return;
                }

                const formData = new FormData();
                formData.append("file", fileInput.files[0]);
                const loadIndex = layer.load(1, {shade: [0.1, '#fff'], time: 10000});

                $.ajax({
                    url: prefix + "/upload",
                    type: "POST",
                    data: formData,
                    contentType: false,
                    processData: false,
                    dataType: "json",
                    timeout: 10000,
                    crossDomain: true,
                    xhrFields: { withCredentials: true },
                    success: function(res) {
                        layer.close(loadIndex);
                        const result = res.predictResult || res;
                        console.log("上传接口返回：", result);
                        console.log("上传接口返回：", res);

                        // 核心修改：获取返回的firstName并赋值
                        imgFirstname = res.fileName ;
                        console.log(imgFirstname)
                        if (!imgFirstname) {
                            $.modal.msgWarning("上传成功，但未获取到图片firstName！");
                            return;
                        }

                        if (!result) {
                            $.modal.msgError("上传失败：接口返回空数据！");
                            return;
                        }
                        if (result.code !== 200) {
                            $.modal.msgError("上传失败：" + (result.msg || "接口返回错误"));
                            return;
                        }
                        if (!result.data) {
                            $.modal.msgError("上传失败：未获取到图片数据！");
                            return;
                        }

                        if (result.data.is_book) {
                            // 将firstName赋值给隐藏域img
                            $("#img").val(imgFirstname);
                            $.modal.msgSuccess(`
                            图片上传成功！<br/>
                            识别结果：是图书图片<br/>
                            置信度：${result.data.confidence || '未知'}
                        `);
                        } else {
                            $("#previewImg").hide().attr("src", "");
                            $("#img").val("");
                            imgFirstname = "";
                            localPreviewSrc = "";
                            fileInput.value = "";
                            $.modal.msgError(`
                            上传失败：非图书相关图片<br/>
                            置信度：${result.data.confidence || '未知'}<br/>
                            请重新选择图片！
                        `);
                        }
                    },
                    error: function(xhr, status, error) {
                        layer.close(loadIndex);
                        console.error("上传失败详情：", xhr, status, error);
                        if (status === "timeout") {
                            $.modal.msgError("上传超时，请检查网络或重试！");
                        } else if (status === "error") {
                            $.modal.msgError(`上传失败：${xhr.status} - ${xhr.statusText}`);
                        } else {
                            $.modal.msgError(`上传失败：${status} - ${error}`);
                        }
                    },
                    complete: function() {
                        $("#imgFile").val("");
                    }
                });
            } catch (e) {
                console.error("上传图片异常：", e);
                $.modal.msgError("上传图片出错：" + e.message);
            }
        }

        // ========== 重置 ==========
        function resetPreview() {
            try {
                $("#previewImg").hide().attr("src", "");
                $("#img").val("");
                $("#imgFile").val("");
                localPreviewSrc = "";
                imgFirstname = ""; // 重置firstName
                $("#publicTime").val(""); // 重置出版时间
                $("#form-book-add")[0].reset();
                // 清除校验错误提示
                $("#form-book-add").validate().resetForm();
                $.modal.msgSuccess("表单重置成功！");
            } catch (e) {
                console.error("重置表单异常：", e);
            }
        }
    </script>
</body>
</html>